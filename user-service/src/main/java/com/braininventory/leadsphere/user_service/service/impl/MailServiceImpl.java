package com.braininventory.leadsphere.user_service.service.impl;import com.braininventory.leadsphere.user_service.entity.User;import com.braininventory.leadsphere.user_service.repository.UserRepository;import com.braininventory.leadsphere.user_service.service.MailService;import com.braininventory.leadsphere.user_service.service.UserService;import jakarta.mail.MessagingException;import jakarta.mail.internet.MimeMessage;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.mail.javamail.JavaMailSender;import org.springframework.mail.javamail.MimeMessageHelper;import org.springframework.stereotype.Service;import org.thymeleaf.TemplateEngine;import org.thymeleaf.context.Context;@Servicepublic class MailServiceImpl implements MailService {    @Autowired    private UserRepository userRepository;    private final JavaMailSender mailSender;    private final TemplateEngine templateEngine;    @Autowired    public MailServiceImpl(JavaMailSender mailSender, TemplateEngine templateEngine) {        this.mailSender = mailSender;        this.templateEngine = templateEngine;    }    @Override    public void sendInviteEmail(String toEmail, String password, String firstName) {        try {            String loginUrl = "http://localhost:5173/login";            Context context = new Context();            context.setVariable("loginUrl", loginUrl);            context.setVariable("temporaryPassword", password);            // This matches th:text="${memberName}" in your HTML            context.setVariable("memberName", firstName);            // If you want to show the logo from the resources folder, you can add it here            // context.setVariable("logoUrl", "cid:logoImage");            String htmlContent = templateEngine.process("invite-email", context);            MimeMessage mimeMessage = mailSender.createMimeMessage();            // Set 'true' for multipart (required for images/attachments)            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");            helper.setTo(toEmail);            helper.setSubject("You're invited to InventoTrack!");            helper.setText(htmlContent, true);            // Optional: To make the logo work from src/main/resources/templates/img.png            // ClassPathResource res = new ClassPathResource("templates/img.png");            // helper.addInline("logoImage", res);            mailSender.send(mimeMessage);        } catch (Exception e) {            throw new RuntimeException("Failed to send invite email", e);        }    }    @Override    public void sendForgetPasswordEmail(String toEmail, String resetToken) {        String resetLink = "http://localhost:5173/reset-password?token=" + resetToken;        // 1. Fetch the user from the database        User user = userRepository.findByEmail(toEmail);        Context context = new Context();        // 2. Set the username variable to the user's actual name        // If user might be null, it's good practice to add a null check here        if (user != null) {            context.setVariable("username", user.getFirstName() + " " + user.getLastName());        } else {            context.setVariable("username", "User"); // Fallback if user not found        }        context.setVariable("resetLink", resetLink);        context.setVariable("expiryMinutes", 15);        String body = templateEngine.process("forget-password", context);        MimeMessage message = mailSender.createMimeMessage();        try {            MimeMessageHelper helper = new MimeMessageHelper(message, true);            helper.setTo(toEmail);            helper.setSubject("Password Reset Request");            helper.setText(body, true); // true = HTML            mailSender.send(message);        } catch (MessagingException e) {            throw new RuntimeException("Failed to send email", e);        }    }}